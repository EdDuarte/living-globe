<!DOCTYPE HTML>
<html> 
<head> 
	<title>Dados Demograficos Mudiais </title> 
	<style> 
		body { margin: 0; } 
		canvas { width: 100%; height: 100%; horizontal-align:right; } 

		#ex1Slider .slider-selection {
			background: #BABABA;
		}
	</style> 
	<meta charset="UTF-8">
	<link rel="stylesheet" href='http://fonts.googleapis.com/css?family=Raleway:300' type='text/css'>
	<link rel="stylesheet" href="css/bootstrap.css">
	<link rel="stylesheet" href="css/bootstrap-slider.min.css">
	<link rel="stylesheet" href="css/jquery.nouislider.min.css">
	<link rel="stylesheet" href="css/jquery.nouislider.pips.css">
	<style type="text/css">
		#parameters {
			position: fixed;
			height: 26px;
			width: 219px;
			left: 0;
			bottom: 0;
			margin: 6px;
			height: 400px;
			width: 400px;
			/*background-color: red;*/
		}
		#credits {
			position: fixed;
			height: 26px;
			width: 219px;
			bottom: 0;
			right: 0;
			margin: 6px;
			width: 400px;
			height: 20px;
			/*background-color: red;*/
		}
		#search {
			position: fixed;
			top: 0;
			right: 0;
			margin: 6px;
			/*background-color: red;*/
		}
		h1, h2, h3, h4, h5, h6 {
			font-family: 'Raleway', sans-serif;
		}
		p, div, button {
			font-family: 'Raleway', sans-serif;
		}
		#sliderPopulation .noUi-connect {
			background: #AA4439;
		}
		#sliderDensity .noUi-connect {
			background: #AA7039;
		}
		#sliderBirth .noUi-connect {
			background: #255E69;
		}
		#sliderDeath .noUi-connect {
			background: #2B803E;
		}
	</style>

</head> 
<body> 
	<script type="text/javascript" src="js/three.js"></script>
	<script type="text/javascript" src="js/OrbitControls.js"></script>
	<script type="text/javascript" src="js/TrackballControls.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="text/javascript" src="js/jquery.csv-0.71.min.js"></script>
	<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
	<script type="text/javascript" src="js/numeral.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/bootstrap-slider.min.js"></script>
	<script type="text/javascript" src="js/jquery.nouislider.all.min.js"></script>

	<div id="search" >
		<form class="navbar-search pull-left">
			<input type="text" class="search-query" placeholder="Search">
		</form>
	</div>

	<div id="worldIntercept">

		<div id="parameters" >
			<br/><br/>

			<table>
				<tr>
					<td width="80px">
						<div id="sliderPopulation" style="height: 300px;"></div>
						<div id="sliderDensity" hidden="true" style="height: 300px;"></div>
						<div id="sliderBirth" hidden="true" style="height: 300px;"></div>
						<div id="sliderDeath" hidden="true" style="height: 300px;"></div>
					</td>
					<td>
						<spam id="detailsContainer" style="color: white;"></spam>
					</td>
				</tr>
			</table>
			<br/>
			<div class="btn-group" data-toggle="buttons-radio">
				<button id="buttonPopulation" type="button" class="btn btn-large btn-inverse btn active">Population</button>
				<button id="buttonDensity" type="button" class="btn btn-large btn-inverse">Density</button>
				<button id="buttonBirth" type="button" class="btn btn-large btn-inverse">Birth Rate</button>
				<button id="buttonDeath" type="button" class="btn btn-large btn-inverse">Death Rate</button>
			</div>

		</div>
		<div id="credits" style="color: white;">
			Ed Duarte & Pedro Bordonhos - All rights reserved 2015 
		</div>

		<div id="worldContainer" style="width: 100%; height: 100%; background-color:black; " />

	</div>

	<script>
		var countryData = [];
		var countryRepresented = [];
		var countryBox = [];

		var maxPopulation = 0;
		var maxDensity = 0;
		var maxBirths = 0;
		var maxDeaths = 0;

		var selectedMinPopulation = 0;
		var selectedMaxPopulation = 0;
		var selectedMinDensity = 0;
		var selectedMaxDensity = 0;
		var selectedMinBirths = 0;
		var selectedMaxBirths = 0;
		var selectedMinDeaths = 0;
		var selectedMaxDeaths = 0;

		// data type can be 0 (population), 1 (density), 2 (birth rate) and 3 (death rate)
		var selectedDataType = 0;

		// setup sliders
		var sPopulation = $('#sliderPopulation');
		sPopulation.on({
			slide: function(){
				newRange = sPopulation.val();
				selectedMinPopulation = newRange[0];
				selectedMaxPopulation = newRange[1];
				filterData(countryData);
			}
		});
		var sDensity = $('#sliderDensity');
		sDensity.on({
			slide: function(){
				newRange = sDensity.val();
				selectedMinDensity = newRange[0];
				selectedMaxDensity = newRange[1];
				filterData(countryData);
			}
		});
		var sBirths = $('#sliderBirth');
		sBirths.on({
			slide: function(){
				newRange = sBirths.val();
				selectedMinBirths = newRange[0];
				selectedMaxBirths = newRange[1];
				filterData(countryData);
			}
		});
		var sDeaths = $('#sliderDeath');
		sDeaths.on({
			slide: function(){
				newRange = sDeaths.val();
				selectedMinDeaths = newRange[0];
				selectedMaxDeaths = newRange[1];
				filterData(countryData);
			}
		});

		$('#buttonPopulation').click(function(){
			sPopulation.show();
			sDensity.hide();
			sBirths.hide();
			sDeaths.hide();
			selectedDataType = 0;
			filterData(countryData);
		});
		$('#buttonDensity').click(function(){
			sPopulation.hide();
			sDensity.show();
			sBirths.hide();
			sDeaths.hide();
			selectedDataType = 1;
			filterData(countryData);
		});
		$('#buttonBirth').click(function(){
			sPopulation.hide();
			sDensity.hide();
			sBirths.show();
			sDeaths.hide();
			selectedDataType = 2;
			filterData(countryData);
		});
		$('#buttonDeath').click(function(){
			sPopulation.hide();
			sDensity.hide();
			sBirths.hide();
			sDeaths.show();
			selectedDataType = 3;
			filterData(countryData);
		});

		// Initialize data

		$(document).ready(function() {
			$.ajax({
				type: "GET",
				url: "data.csv",
				dataType: "text",
				success: function(data) {
					processData(data);}
				});
		});

		function processData (data) {
			countryData = CSVToArray(data);
			analyseMaxValues();
			filterData(countryData);
			//alert (countryData.length);
		}

		function analyseMaxValues() {
			// get all max values and create a scale
			var maxi;
			for (var i = 1; i < countryData.length-1; i++) {
				var population = parseInt(countryData[i][5]);
				var density = parseInt(countryData[i][6]);
				var births = parseInt(countryData[i][8]);
				var deaths = parseInt(countryData[i][12]);

				if (maxPopulation < population) {
					maxPopulation = population;
					maxi = i;
				}

				if (maxDensity < density) {
					maxDensity = density;
				}

				if (maxBirths < births) {
					maxBirths = births;
				}

				if (maxDeaths < deaths){
					maxDeaths = deaths;
				}
			}

			selectedMinPopulation = 0;
			selectedMaxPopulation = maxPopulation;
			selectedMinDensity = 0;
			selectedMaxDensity = maxDensity;
			selectedMinBirths = 0;
			selectedMaxBirths = maxBirths;
			selectedMinDeaths = 0;
			selectedMaxDeaths = maxDeaths;

	        // get the range for the sliders based on the max values
	        sPopulation.noUiSlider({
	        	start: [selectedMinPopulation, selectedMaxPopulation],
	        	orientation: 'vertical',
	        	direction: 'rtl',
	        	steps: maxPopulation,
	        	connect: true,
	        	range: {
	        		'min': 0,
	        		'max': maxPopulation
	        	}
	        }, true);
	        sPopulation.noUiSlider_pips({
	        	mode: 'steps',
	        	density: 5
	        });

	        sDensity.noUiSlider({
	        	start: [selectedMinDensity, selectedMaxDensity],
	        	orientation: 'vertical',
	        	direction: 'rtl',
	        	steps: 10,
	        	connect: true,
	        	range: {
	        		'min': 0,
	        		'max': maxDensity
	        	}
	        }, true);
	        sDensity.noUiSlider_pips({
	        	mode: 'steps',
	        	density: 5
	        });

	        sBirths.noUiSlider({
	        	start: [selectedMinBirths, selectedMaxBirths],
	        	orientation: 'vertical',
	        	direction: 'rtl',
	        	steps: 10,
	        	connect: true,
	        	range: {
	        		'min': 0,
	        		'max': maxBirths
	        	}
	        }, true);
	        sBirths.noUiSlider_pips({
	        	mode: 'steps',
	        	density: 5
	        });

	        sDeaths.noUiSlider({
	        	start: [selectedMinDeaths, selectedMaxDeaths],
	        	orientation: 'vertical',
	        	direction: 'rtl',
	        	steps: 10,
	        	connect: true,
	        	range: {
	        		'min': 0,
	        		'max': maxDeaths
	        	}
	        }, true);
	        sDeaths.noUiSlider_pips({
	        	mode: 'steps',
	        	density: 5
	        });
	    }

	    var width = window.innerWidth;
	    var height = window.innerHeight;
	    var aspectRatio = width / height;

	    var scene = new THREE.Scene(); 
	    var camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
	    var renderer = new THREE.WebGLRenderer();

	    renderer.setSize(width, height);
	    worldContainer.appendChild(renderer.domElement);
	    var controls = new THREE.TrackballControls(camera, worldIntercept);

	    var world = new THREE.SphereGeometry(60,25,25);
	    var m1 = new THREE.MeshPhongMaterial({
	    	ambient: '#040404',
	    	specular: '#040404',
	    	shininess: 1,
	    });
	    m1.map = new THREE.ImageUtils.loadTexture("img/earth_specularmap_low.jpg");

	    var sol = new THREE.DirectionalLight( 0xfffff, 1.5 ); 
	    sol.position.set( 0, 0, 1 ); 
	    scene.add( sol );

	    var sol1 = new THREE.DirectionalLight( 0xfffff, 1.5 ); 
	    sol1.position.set( 1, 0, 0 );
	    scene.add( sol1 );

	    var sol2 = new THREE.DirectionalLight( 0xfffff, 1.5 ); 
	    sol2.position.set( 0, 1, 0 );
	    scene.add( sol2 );

	    var sp = new THREE.Mesh(world,m1);
	    scene.add(sp);

	    camera.position.z = 120;


	    function latLongToVector3(lat, lon, radius, heigth) {

	    	var phi = (lat)*Math.PI/180;
	    	var theta = (lon-180)*Math.PI/180;

	    	var x = -(radius+heigth) * Math.cos(phi) * Math.cos(theta);
	    	var y = (radius+heigth) * Math.sin(phi);
	    	var z = (radius+heigth) * Math.cos(phi) * Math.sin(theta);

	    	return new THREE.Vector3(x,y,z);
	    }

	    var projector = new THREE.Projector(), 
	    mouse_vector = new THREE.Vector3(), 
	    mouse = { x: 0, y: 0, z: 1 },
	    ray = new THREE.Raycaster(new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, 0)),
	    intersects = [];

	    renderer.domElement.addEventListener('mousedown', onMouseDown);

	    function getDetails(countryLine) {
	    	// text = "<h1>" + countryLine[0] + " (" + countryLine[15] + ")</h1><h3>" +countryLine[1] + "</h3>" +
	    	text = "<h1>" + countryLine[1] + "</h1><h3>(" +countryLine[0] + ")</h3>" +
	    	"<h5><span>" + numeral(countryLine[4]).format('0,0') + " km²</span></h5>" + 
	    	"<h5>Population <span class='label label-info'>" + numeral(countryLine[5]).format('0,0') + "</span></h5>" + 
	    	"<h5>Density <span class='label label-primary'>" + numeral(countryLine[6]).format('0,0') + "</span></h5>" +
	    	"<h5>Births <span class='label label-success'>" + numeral(countryLine[8]).format('0,0') + "</span></h5>" + 
	    	"<h5>Deaths <span class='label label-warning'>" + numeral(countryLine[12]).format('0,0') + "</span></h5>";
	    	return text;
	    }

	    function filterData(countryData) {

	    	// remove previous cubes
	    	for (var i = 0 ; i < countryBox.length; i++) {
	    		scene.remove(countryBox[i])
	    	}

	       	// arrays that will contain all our cubes
	       	countryRepresented = [];
	       	countryBox = [];

	       	for (var i = 1; i < countryData.length-1; i++) {

	       		var c = countryData[i];

		        // get the data, and set the offset, we need to do this since the x,y coordinates
		        var lat = parseInt(c[2]);
		        var lon = parseInt(c[3]);
		        var population = parseInt(c[5]);
		        var density = parseInt(c[6]);
		        var births = parseInt(c[8]);
		        var deaths = parseInt(c[12]);

		        var value = 0;

		        if (selectedDataType == 0 && population >= selectedMinPopulation && population <= selectedMaxPopulation) {
		        	value = scaleDown(maxPopulation, 1, selectedMaxPopulation, selectedMinPopulation, population);
		        	value = scaleDown(selectedMaxPopulation, selectedMinPopulation, 95, 0, population);

		        } else if (selectedDataType == 1 && density >= selectedMinDensity && density <= selectedMaxDensity) {
		        	value = scaleDown(maxDensity, 1, selectedMaxDensity, selectedMinDensity, density);
		        	value = scaleDown(selectedMaxDensity, selectedMinDensity, 95, 0, density);

		        } else if (selectedDataType == 2 && births >= selectedMinBirths && births <= selectedMaxBirths) {
		        	value = scaleDown(maxBirths, 1, selectedMaxBirths, selectedMinBirths, births);
		        	value = scaleDown(selectedMaxBirths, selectedMinBirths, 95, 0, births);

		        } else if (selectedDataType == 3 && deaths >= selectedMinDeaths && deaths <= selectedMaxDeaths) {
		        	value = scaleDown(maxDeaths, 1, selectedMaxDeaths, selectedMinDeaths, deaths);
		        	value = scaleDown(selectedMaxDeaths, selectedMinDeaths, 95, 0, deaths);
		        }

		        if(value == 0) {
		        	continue;
		        }

		        var position = latLongToVector3(lat, lon, 59, 1);
		        var cubeMat = new THREE.MeshLambertMaterial({color: 0xffffff, opacity:0.6, emissive:0xffffff});

				// a CubeGeometry is used instead of a BoxGeometry
				var box = new THREE.CubeGeometry(0.5, 0.5, value);
				var cube = new THREE.Mesh( box, cubeMat );

				cube.position.x = position.x;
				cube.position.y = position.y;
				cube.position.z = position.z;
				cube.lookAt(new THREE.Vector3(0,0,0));

				scene.add(cube); 

				// add the cube to an array, so it can be easily looked up
				countryBox.push(cube);
				countryRepresented.push(c);
			}

	        // create a new mesh, containing all the other meshes.
	        //var total = new THREE.Mesh(geom,new THREE.MeshFaceMaterial());

	        // and add the total mesh to the scene
	    }

	    function onMouseDown(e) {
			//Evita que o evento chame outra função
			e.preventDefault();
			
			//Começa a tranformação entre coordenadas do rato e three.js
			mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
			mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
			

			// Vector 3D que indica a direção do vetor a partir do pixel
			mouse_vector.set(mouse.x, mouse.y, mouse.z);

			// Define um ponto no espaço 3D de acordo com o clique do rato
			projector.unprojectVector(mouse_vector, camera);

			var direction = mouse_vector.sub(camera.position).normalize();

			// Chama o raycaster com a posição da câmara e a direção
			ray.set(camera.position, direction);

			// Verifica se o raio intersetou algum objeto na cena
			/*
			for (var i = 0 ; i < countryBox.length-1 ; i++) {
				countryBox[i].material.color.setHex( 0xffffff );
				cube.material.color.setHex( 0xffffff );
				cube1.material.color.setHex( 0xffffff );
			}
			*/

			for (var i = 0 ; i < countryBox.length-1 ; i++) {
				intersects = ray.intersectObject(countryBox[i]);
				if (intersects.length) {
					detailsContainer.innerHTML = getDetails(countryRepresented[i]);
				}
			}
		}

		function scaleDown(oldRangeMax, oldRangeMin, newRangeMax, newRangeMin, input) {
			var percent = (input - oldRangeMin) / (oldRangeMax - oldRangeMin);
			return percent * (newRangeMax - newRangeMin) + newRangeMin;
		}

		function render() {
			requestAnimationFrame(render);
			renderer.render(scene, camera);
			controls.update();
		}

		render();

	</script> 

</body>
</html>